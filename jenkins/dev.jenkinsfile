pipeline {
    agent {
        node {
            label 'linux-server'
        }
    }
    options {
        timeout(time: 1, unit: 'HOURS')
    }
    environment {
        TF_VAR_ENV = 'dev'
        PIPENV_PIPFILE = "${WORKSPACE}/lambda/pipfile"
    }
    stages {
        stage('Initializing.') {
            steps {
                echo 'installing environment dependencies...'
                timeout(time: 5, unit: 'MINUTES') {
                    git branch: 'main',
                        url: 'https://github.com/issambenhida/sageowl.git',
                        credentialsId: '01'
                }
                /* sh 'pipenv install' */
            }
        }
        stage('Code Quality Check.') {
            stages{
                stage('Terraform Check.'){
                    steps{
                        sh '''
                        cd ${WORKSPACE}/environments/dev
                        tflocal fmt -check
                        tflint
                        '''
                    }
                }
                stage('Ansible Check.'){
                    steps{
                        sh 'ansible-lint ansible/*'
                    }
                }
                stage('Python Check.'){
                    steps{
                        sh '''
                        flake8 lambda/*.py
                        pylint lambda/*.py
                        safety check || pip-audit
                        '''
                    }
                }
            }
            /*
            pipenv run
            */
        }
    }
}
